<!doctype html>
<html lang="en">
  <head>
    <title>Programmer's Calculator</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#2F3BA2" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        background-color: #e9ecef;
        font-size: 16pt;
      }
      .calculator {
        display: grid;
        grid-template-columns: max-content 1fr;
        gap: 0.3rem 0.3rem;
        align-items: center;
      }
      input {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
      }
      button {
        width: 100%;
        font-size: 1.2rem;
      }
      .keyboard {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #f8f9fa;
        display: none; /* Switched to grid when visible */
        grid-template-columns: repeat(4, 1fr);
        gap: 5px;
        padding: 10px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }
      .keyboard button {
        padding: 15px;
        font-size: 1.5rem;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        cursor: pointer;
        touch-action: manipulation;
      }
      .keyboard button:active {
        background: #e2e6ea;
      }
      .keyboard .wide {
        grid-column: span 2;
      }
    </style>
    <!-- Last modified Mon Feb 23 07:08:21 PM MST 2026 -->
  </head>
  <body>
    <div class="calculator">
      <label for="dec">Dec:</label>
      <input id="dec" inputmode="numeric" />
      <label for="hex">Hex:</label>
      <input id="hex" />
      <label for="oct">Oct:</label>
      <input id="oct" inputmode="numeric" />
      <label for="bin">Bin:</label>
      <input id="bin" inputmode="numeric" />
      <label for="char">Char:</label>
      <input id="char" />
      <label for="expr">Exp:</label>
      <input id="expr" />
      <label for="eql">&nbsp;</label>
      <button id="eql">=</button>
    </div>
    <div id="hex-keyboard" class="keyboard">
      <button>0</button><button>1</button><button>2</button><button>3</button>
      <button>4</button><button>5</button><button>6</button><button>7</button>
      <button>8</button><button>9</button><button>A</button><button>B</button>
      <button>C</button><button>D</button><button>E</button><button>F</button>
      <button class="wide" id="hex-del">Del</button>
      <button class="wide" id="hex-hide">Hide</button>
    </div>
    <script>
      const isTouch = window.matchMedia("(pointer: coarse)").matches;
      const hexInput = document.getElementById("hex");
      const hexKeyboard = document.getElementById("hex-keyboard");
      let val = 0;

      function updateVal(newVal, validChar) {
        if (newVal != val && newVal >= 0 && newVal <= 0xffffffff) {
          val = newVal;
        }
        document.getElementById("dec").value = val.toString(10);
        document.getElementById("hex").value = val.toString(16).toUpperCase();
        document.getElementById("oct").value = val.toString(8);
        document.getElementById("bin").value = val.toString(2);
        document.getElementById("bin").value = val.toString(2);
        const c = val >= 32 && val < 0xffff ? String.fromCharCode(val) : " ";

        document.getElementById("char").value = c;
      }

      function doUpdate(valTxt, base) {
        if (valTxt === "") valTxt = "0";
        const newVal = Number.parseInt(valTxt, base);
        updateVal(newVal, false);
      }

      const VALID_EXPR = /^[-+*/<>()&|^%0-9a-fA-Fx ]+$/;
      let getValue = () => 0;

      function doEvaluate() {
        const expr = document.getElementById("expr");
        if (VALID_EXPR.test(expr.value)) {
          eval(`getValue = () => ${expr.value}`);
          updateVal(getValue(), true);
        }
      }

      for (const i of [
        ["dec", 10],
        ["hex", 16],
        ["oct", 8],
        ["bin", 2],
      ]) {
        const elId = i[0];
        const base = i[1];
        document
          .getElementById(elId)
          .addEventListener("input", (e) => doUpdate(e.target.value, base));
      }
      document
        .getElementById("expr")
        .addEventListener(
          "keyup",
          ({ key }) => key === "Enter" && doEvaluate(),
        );
      document
        .getElementById("eql")
        .addEventListener("click", () => doEvaluate());
      document
        .getElementById("char")
        .addEventListener("input", (e) =>
          updateVal(e.target.value.charCodeAt(0), true),
        );
      if (isTouch) {
        hexInput.setAttribute("inputmode", "none");
        hexInput.addEventListener("focus", () => {
          hexKeyboard.style.display = "grid";
        });
        document.addEventListener(
          "click",
          (e) => {
            // Hide hex keyboard on non-hex touch
            if (!hexKeyboard.contains(e.target) && e.target !== hexInput) {
              hexKeyboard.style.display = "none";
            }
          },
          true,
        );
      }
      hexKeyboard.querySelectorAll("button").forEach((b) => {
        b.addEventListener("click", (e) => {
          //e.preventDefault(); // Keep focus on hex input
          const key = b.textContent;
          const currentVal = hexInput.value;

          if (key === "Del") {
            hexInput.value = currentVal.slice(0, -1);
            doUpdate(hexInput.value, 16);
            hexInput.focus();
          } else if (key === "Hide") {
            hexKeyboard.style.display = "none";
            hexInput.blur();
          } else {
            // Number or letter key
            hexInput.value = currentVal + key;
            doUpdate(hexInput.value, 16);
            hexInput.selectionStart = hexInput.value.length + 1;
            hexInput.focus();
          }
        });
      });
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("sw.js")
            .then((registration) => {
              console.log(
                "Service Worker registered with scope:",
                registration.scope,
              );
            })
            .catch((error) => {
              console.log("Service Worker registration failed:", error);
            });
        });
      }
    </script>
  </body>
</html>
